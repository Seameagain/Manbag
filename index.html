<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Marketplace</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<h1 id="welcome">กำลังโหลด...</h1>
<div id="products"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabase = supabase.createClient(
  "https://azmodrfrleszxxqrihfu.supabase.co",
  "PASTE_ANON_PUBLIC_KEY"
);

async function init() {
  // ไม่ต้องรอ session ก่อนแสดงหน้า
  const { data } = await supabase.auth.getSession().catch(()=>({data:null}));

  if (data && data.session) {
    document.getElementById("welcome").innerText =
      `สวัสดีคุณ ${data.session.user.user_metadata.full_name || data.session.user.email} ซื้ออะไรดี`;
  } else {
    document.getElementById("welcome").innerText =
      `สวัสดี! กรุณาเข้าสู่ระบบเพื่อดูสินค้าของคุณ`;
  }

  loadProducts();
}

async function loadProducts() {
  const { data, error } = await supabase.from("products").select("*");
  if (error) {
    document.getElementById("products").innerText = error.message;
    return;
  }
  document.getElementById("products").innerHTML = data.map(p => `
    <div class="card">
      <h3>${p.title}</h3>
      <p>${p.price} บาท</p>
      <button onclick="buy('${p.id}')">ซื้อ</button>
    </div>
  `).join("");
}

function buy(id) {
  fetch("/api/create-checkout", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ productId: id })
  })
  .then(r=>r.json())
  .then(d=>window.location = d.url)
  .catch(err => console.error(err));
}

init();
</script>

</body>
</html>
